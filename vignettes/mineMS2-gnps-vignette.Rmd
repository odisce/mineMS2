---
title: 'Application to the interpretation of the GNPS components'
author: "Alexis Delabrière, Coline Gianfrotta and Etienne Thévenot"
date: "`r Sys.Date()`"
package: mineMS2

vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::knitr}
  %\VignetteDepends{igraph}
  %\VignetteEncoding{UTF-8}
  %\VignetteKeywords{Metabolomics, MS/MS, Fragmentation pattern, Frequent Subgraph Mining}
bibliography: "mineMS2-vignette.bib"
output:
  BiocStyle::html_document:
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This vignette describes the use of the _mineMS2_ software coupled to the GNPS MS/MS molecular networking methodology [@watrous_mass_2012]. In this example, the molecular network has been precomputed on the GNPS website and extracted in the *.graphML* format (file  *ex_gnps_network.graphml* inside the *dataset* subdirectory of the _mineMS2_ installation folder). We strongly recommend to compute the patterns and the GNPS network on the same .mgf file to avoid matching issues.

# Pre-requisites

## Dataset

Secondary metabolites of *Penicillium verrucosum* have been studied by Data Dependent Acquisition [@Hautbergue2017]. The subset of 45 MS/MS spectra provided in the package corresponds to the spectra at the HCD20 energy with an associated MS signal in positive mode (as detected by the MZmine software, @Pluskal2010).

## Initialization

The initialization loads the required packages and extracts the data paths.

```{r path_gnps}
library(mineMS2)
path_demo <- system.file("dataset",package = "mineMS2")
path_network <- file.path(path_demo, "ex_gnps_network.graphml")
path_mgf <- file.path(path_demo, "ex_mgf.mgf")
path_supp_info <- file.path(path_demo, "ex_supp_infos.csv")
```

## Patterns mining

The pattern mining step is detailed in the [mineMS2 main vignette](mineMS2-vignette.html). Briefly, i) all mass differences within the spectra are computed, ii) a graph representation of each MS/MS spectrum using the mass differences as edges is built (Directed Acyclic Graph, DAG), and iii) the DAGs are mined to extract frequent patterns.

```{r pattern_computing,message=FALSE}
supp_infos <- read.table(path_supp_info, header = TRUE, sep = ";")

### Sepctra are read and thresholded
m2l <- ms2Lib(path_mgf,suppInfos = supp_infos, intThreshold = 3000)

### An ID is added to each spectra
infos <- getInfo(m2l,"S")
ids <- paste(paste0("MZ",infos[,"mz"]), paste0("RT",infos[,"rt"]), sep = "_")
m2l <- setIds(m2l,ids)

### DAGs are created
m2l <- discretizeMassLosses(m2l, dmz = 0.008, ppm = 8, heteroAtoms = FALSE, maxFrags = 15)

### Patterns are detected
m2l <- mineClosedSubgraphs(m2l, sizeMin = 1, count = 2)
```
A total of `r length(m2l)` patterns (i.e. fragmentation subgraphs) were detected.

In the rest of this vignette, we show how these patterns can be used to interpret the components of molecular networks generated by GNPS.

# Coupling mineMS2 to GNPS

## Loading the GNPS network

The GNPS network may be read using the *igraph* package:
```{r gnps_network_reading, warning=FALSE, message=FALSE}
library(igraph)

net_gnps <- read_graph(path_network, "graphml")
```

Since self-edges (i.e. single loops) are automatically added by GNPS to single nodes, we use the _simplify_ function form the *igraph* package to remove these edges.

```{r simplify_network}
net_gnps <- simplify(net_gnps, remove.multiple = FALSE, edge.attr.comb = "ignore")
```

An overview of the GNPS network after this processing is shown below (as visualized with the cytoscape software [@Shannon2003]):

```{r net_raw, out.width = "500px", fig.align = 'center', echo=FALSE}
knitr::include_graphics("rawGNPS.png")
```

Within this network, the *mineMS2* patterns are useful to interpret the connected components (subgraphs in which any two nodes are connected by a path), the cliques (subgraphs in which any all pairs of nodes are connected), as well as the strong similarities between nodes, as described below.

## Extracting components from a molecular network

The connected components and the cliques may be extracted using the *findGNPSComponents* function. The important parameters of this function are i) the _minSize_ parameter, which indicates the minimum size of the detected cliques, and ii) the _pairThreshold_ threshold, which indicates a similarity threshold for which an explanation of a single edge is generated.

```{r gnps_components}
components <- findGNPSComponents(net_gnps, minSize = 3, pairThreshold = 0.9)
```


## Finding patterns explaining the extracted components

*mineMS2* implements a matching between components and subgraphs occurences using metrics related to binary classification, including the _recall_, the _precision_ and the [_F1-score_](https://en.wikipedia.org/wiki/F1_score). The patterns maximizing the given metric are returned; in case of a tie, a second metric may be used. In the case of GNPS interpretation, we set the metric argument to `c("recall","accuracy","size")` to indicate that a pattern maximizing recall is extracted for each component, accuracy and size being then used to split ties. This will reduce the number of explaining patterns to 1 in most cases.

```{r patterns_explaining_components}
patterns <- findPatternsExplainingComponents(m2l, components, metric = c("recall","precision","size"))
```

The returned list includes all the metric values for the selected patterns.

```{r pattern_showing}
patterns[[1]]
```

The selected ids can then be extracted: `r ids <- sapply(patterns,'[',i=1,j="id")`.

These patterns can be viewed using the _plot_ and _plotOccurences_ functions, which are wrapped inside the _plotPatterns_ function for convenience. This function may be used to generate a pdf output.
```{r pattern_plotting, fig.align='center'}
### Here a single id is selected for clarity.
plotPatterns(m2l,patterns[[4]][,"id"],components = components[4])
```

The network may be directly annotated using the _annotateNetwork_ function.

```{r annotate_network}
annotated_net <- annotateNetwork(components, net_gnps, patterns)
```

The annotated network can be exported using the _write\_graph_ function from the *igraph* package.

```{r export_graph,eval=FALSE}
write_graph(graph = annotated_net, format = "graphml", file = "ex_annotated_gnps_network.graphml")
```

This network can be visualized in Cytoscape (note that the GraphML format is supported by Cytoscape 3: select 'File > Import > Network from file'; with Cytoscape 2, the GraphMLReader plugin is needed):

```{r net_annotated, out.width = "500px",fig.align = 'center',echo=FALSE}
knitr::include_graphics("annotatedGNPS.png")
```

To visualize the colors, the _enhancedGraphics_ App from Cytoscape is required ('Apps > Install Apps > Search: enhanced Graphics'). Then, in the _Style_ tab from the _Control Panel_, select for the _Image/Chart 1_ the _Column: colorComponents_ and the _Mapping Type: Passthrough Mapping_. Each component is assigned a color: nodes with several colors belong to several components.

## Interpreting the components in terms of fragmentation patterns

We can now interpret the molecular network in terms of fragmentation patterns.

First, we investigate the pattern explaining the biggest component (which consists of isomeric compounds with m/z $513.21$), which is `r patterns[[1]][,"id"]`. We can plot this pattern using the *plotPatterns* method:
```{r P5,fig.align = "center"}
id_pat <- patterns[[1]][,"id"]
plotPatterns(m2l, id_pat)
```

We see that the 6 fragmentation spectra share an $NH_3$ loss. This single $NH_3$ loss is also observed in many different spectra, and is representative of an amine loss.

One may also be interested in highly specific fragmentation similarities, such as the similarity between vertices with m/z $404.09$ and $370.13$, which is explained by component $4$:

```{r Pochratoxins,fig.align = "center"}
id_pat <- patterns[[4]][,"id"]
plot(m2l,id_pat)
```

This pattern includes a loss of $147.068$ with the following information (*findMz* and *getInfo* functions):
```{r loss_phenylalanine}
L147 <- findMz(m2l, 147.068, ppm = 8, dmz = 0.005, type = "L")
getInfo(m2l, L147)

```

We see that one possible formula for the loss is $C_9H_9NO$, which corresponds to phenylalanine.

## Beyond molecular networks: discovering new similarities between spectra

The patterns also help discovering new similarities between spectra. Getting back to the $147.068$ loss above, it is now possible to look for this loss in other patterns using the *select* function:

```{r other_phenyalanine}
ids_phenylalanine <- select(m2l, L147, "P")
ids_phenylalanine
```

The `r ids_phenylalanine[[1]][10]` pattern can be visualized using *plotPatterns*:

```{r phenyalanine, fig.align="center"}
plotPatterns(m2l,ids_phenylalanine[[1]][4])
```

We observe that in addition to the similarity of spectra at m/z $404.09$ and $370.13$ showed in the molecular network, *mineMS2* highlights two isomers at m/z $511.29$ which also share the same pattern, including the $147.068$ loss.
[comment]: # In addition to the $147.068$ loss, the pattern also includes $H_2O$ and $CH_3NO$ losses, which may indicate a common amino acid structure (in addition to the phenyalanine loss). This similariy is completely ignored by GNPS, but is detected by the mineMS2 software.

# Bibliography
